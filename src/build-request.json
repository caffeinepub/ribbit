{
  "kind": "build_request",
  "title": "Fix pond creation: remove caller/principal linkage trap and auto-join creator by phrase-hash userId",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-6",
      "text": "Update `createPond(...)` in `backend/main.mo` so pond creation is not blocked by `caller`/Principal linkage checks or AccessControl permission validation. Specifically, remove/disable the `userIdLinkage` + `caller != linkedPrincipal` authorization gate (and any related `AccessControl.hasPermission(...)` checks) in the pond-creation path so `createPond` can succeed based only on the provided phrase-hash `userId`, including when the caller is anonymous.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "This is the blocker.",
          "ok then fix it then"
        ]
      },
      "acceptanceCriteria": [
        "Calling `createPond(...)` no longer traps due to `caller != linkedPrincipal` for users whose `userId` was previously linked to a different Principal.",
        "`createPond(...)` does not require `AccessControl.hasPermission(... #user)` to succeed for phrase-hash creation flows.",
        "`createPond(...)` can successfully create a pond when called by an anonymous identity, as long as a `userId` is provided."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Update `createPond(...)` in `backend/main.mo` to auto-join the pond creator using the phrase-hash `userId` membership model at creation time: (1) include the creator’s `userId` in the new pond’s `members`, (2) set the new pond’s `memberCount` to reflect this auto-join (must be at least `1` on creation), and (3) immediately update the creator’s phrase-hash `UserProfile.joinedPonds` to include the newly created pond name.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "Therefore the creator is never added to `pond.members`, never added to their profile, never added to `userPonds`.",
          "ok then fix it then"
        ]
      },
      "acceptanceCriteria": [
        "After a successful `createPond(...)` call, `pond.members` contains the creator `userId` exactly once.",
        "After a successful `createPond(...)` call, `pond.memberCount` is `>= 1` and matches the number of unique entries in `pond.members` for a newly created pond.",
        "After a successful `createPond(...)` call, `getUserProfileByPhraseHash(userId)` returns a profile whose `joinedPonds` includes the new pond name."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Ensure `createPond(...)` updates any additional user↔pond relationship indexes used by the app for phrase-hash users. In particular, update the `userPonds` map in `backend/main.mo` so the creator’s `userPonds[userId]` includes the newly created pond name immediately after pond creation (without requiring any Principal-based linkage).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "never added to `userPonds`.",
          "ok then fix it then"
        ]
      },
      "acceptanceCriteria": [
        "After a successful `createPond(...)` call, the `userPonds` entry for the creator `userId` exists and includes the new pond name.",
        "The new pond name is not duplicated in `userPonds[userId]` if `createPond(...)` is retried or if the user already has entries.",
        "No Principal/caller-based checks are required for updating `userPonds` in the pond-creation path."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in `backend/main.mo` (no additional backend services).",
    "Do not add third-party auth; only Internet Identity is supported (but `createPond` must work for anonymous callers in phrase-hash flow).",
    "Use English for any user-facing text (e.g., trap/error messages returned to the UI, if any are changed/added).",
    "Only create `backend/migration.mo` if a state upgrade is required; otherwise do not add migrations."
  ],
  "nonGoals": [
    "Do not redesign the frontend pond creation UI.",
    "Do not change the overall authentication model across the app; this change is limited to removing caller/principal gating from the pond-creation path and ensuring phrase-hash auto-join behavior.",
    "Do not introduce new databases or external storage beyond the existing canister state."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}